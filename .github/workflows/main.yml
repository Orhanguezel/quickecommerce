name: QuickEcommerce Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Deploy to Server via SSH
      # ----------------------------
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          command_timeout: 20m
          script: |
            set -e
            export COMPOSER_ALLOW_SUPERUSER=1

            echo "=== Backup .env files ==="
            cd /var/www/quikecommerce

            # .env dosyalarını yedekle
            [ -f backend-laravel/.env ] && cp backend-laravel/.env /tmp/backend-laravel.env.bak
            [ -f admin-panel/.env.local ] && cp admin-panel/.env.local /tmp/admin-panel.env.bak

            echo "=== Pulling latest changes ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Restore .env files ==="
            # .env dosyalarını geri yükle
            [ -f /tmp/backend-laravel.env.bak ] && cp /tmp/backend-laravel.env.bak backend-laravel/.env
            [ -f /tmp/admin-panel.env.bak ] && cp /tmp/admin-panel.env.bak admin-panel/.env.local

            echo "=== Backend Laravel Setup ==="
            cd /var/www/quikecommerce/backend-laravel

            # .env yoksa oluştur
            if [ ! -f .env ]; then
              cp .env.example .env
              php artisan key:generate
              echo "WARNING: New .env created - configure database settings!"
            fi

            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan migrate --force || echo "Migration skipped"

            echo "=== Admin Panel Setup ==="
            cd /var/www/quikecommerce/admin-panel
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps
            npm run build

            echo "=== PM2 Reload ==="
            pm2 reload quickecommerce-admin || pm2 start ecosystem.config.js --only quickecommerce-admin
            pm2 save

            echo "=== Deploy Complete ==="
            pm2 status
