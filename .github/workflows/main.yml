name: QuickEcommerce Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: quickecommerce-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          command_timeout: 25m
          script: |
            set -euo pipefail
            export COMPOSER_ALLOW_SUPERUSER=1

            echo "=== Backup .env files ==="
            cd /var/www/quikecommerce
            BAK_SUFFIX="$(date +%s)-$$"
            [ -f backend-laravel/.env ] && cp backend-laravel/.env "/tmp/backend-laravel.env.${BAK_SUFFIX}.bak"
            [ -f admin-panel/.env.local ] && cp admin-panel/.env.local "/tmp/admin-panel.env.${BAK_SUFFIX}.bak"
            [ -f customer-web-nextjs/.env.local ] && cp customer-web-nextjs/.env.local "/tmp/customer-web-nextjs.env.${BAK_SUFFIX}.bak"

            echo "=== Pulling latest changes ==="
            git fetch --prune origin main
            git checkout main
            git pull --ff-only origin main

            echo "=== Restore .env files ==="
            [ -f "/tmp/backend-laravel.env.${BAK_SUFFIX}.bak" ] && cp "/tmp/backend-laravel.env.${BAK_SUFFIX}.bak" backend-laravel/.env
            [ -f "/tmp/admin-panel.env.${BAK_SUFFIX}.bak" ] && cp "/tmp/admin-panel.env.${BAK_SUFFIX}.bak" admin-panel/.env.local
            [ -f "/tmp/customer-web-nextjs.env.${BAK_SUFFIX}.bak" ] && cp "/tmp/customer-web-nextjs.env.${BAK_SUFFIX}.bak" customer-web-nextjs/.env.local

            echo "=== Backend Laravel Setup ==="
            cd /var/www/quikecommerce/backend-laravel

            if [ ! -f .env ]; then
              cp .env.example .env
              php artisan key:generate
              echo "WARNING: New .env created - configure database settings!"
            fi

            composer install --no-dev --optimize-autoloader --no-interaction

            echo "=== Fix Storage Permissions ==="
            find storage -type f -exec chown www-data:www-data {} \;
            find storage -type d -exec chown www-data:www-data {} \;
            find storage -type f -exec chmod 664 {} \;
            find storage -type d -exec chmod 775 {} \;
            find bootstrap/cache -type f -exec chown www-data:www-data {} \;
            find bootstrap/cache -type d -exec chown www-data:www-data {} \;
            find bootstrap/cache -type f -exec chmod 664 {} \;
            find bootstrap/cache -type d -exec chmod 775 {} \;

            echo "=== Laravel Cache Clear ==="
            sudo -u www-data php artisan optimize:clear

            echo "=== Fix Storage Symlink ==="
            rm -f public/storage
            sudo -u www-data php artisan storage:link
            ls -la public/storage || echo "WARNING: storage symlink failed!"

            echo "=== Database Migration (SAFE) ==="
            sudo -u www-data php artisan migrate --force

            echo "=== Database Seed (SAFE: ProductionSeeder only) ==="
            sudo -u www-data php artisan db:seed --class=ProductionSeeder --force

            echo "=== Laravel Cache Build ==="
            sudo -u www-data php artisan config:cache
            sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache

            echo "=== Customer Web (Next.js) Setup ==="
            cd /var/www/quikecommerce/customer-web-nextjs
            export NVM_DIR="/root/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            echo "Node version: $(node --version)"

            if [ ! -f .env.local ]; then
              cp .env.example .env.local || echo "WARNING: .env.local missing, using defaults"
            fi

            npm ci
            pm2 stop quickecommerce-customer || true
            npm run build

            echo "Next.js build verification (customer):"
            ls -la /var/www/quikecommerce/customer-web-nextjs/.next/standalone/server.js 2>/dev/null && echo "server.js OK" || echo "ERROR: Build failed!"

            pm2 restart quickecommerce-customer || pm2 start npm --name "quickecommerce-customer" -- start

            echo "=== Admin Panel Setup ==="
            cd /var/www/quikecommerce/admin-panel
            export NVM_DIR="/root/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            echo "Node version: $(node --version)"

            if [ ! -f .env.local ] && [ -f .env.example ]; then
              cp .env.example .env.local
            fi

            npm ci --legacy-peer-deps
            pm2 stop quickecommerce-admin || true
            npm run build
            [ -f .env.local ] && cp .env.local deploy/.env.local

            pm2 restart quickecommerce-admin || pm2 start ecosystem.config.cjs --only quickecommerce-admin

            echo "=== PM2 Save & Verify ==="
            pm2 save
            sleep 3
            pm2 status

            echo "=== Verify Admin Deploy ==="
            ls -la /var/www/quikecommerce/admin-panel/deploy/server.js 2>/dev/null && echo "server.js OK" || echo "ERROR: server.js missing!"

            echo "=== Final Backend Permission Check ==="
            cd /var/www/quikecommerce/backend-laravel
            ls -la storage/framework/cache/data/ | head -10

            echo "=== Deploy Complete ==="
            echo "✅ Backend Laravel: Ready"
            echo "✅ Customer Web (Next.js): Ready at https://sportoonline.com"
            echo "✅ Admin Panel (Next.js): Ready at https://panel.sportoonline.com"
