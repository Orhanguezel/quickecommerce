name: QuickEcommerce Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Deploy to Server via SSH
      # ----------------------------
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          command_timeout: 25m
          script: |
            set -e
            export COMPOSER_ALLOW_SUPERUSER=1

            echo "=== Backup .env files ==="
            cd /var/www/quikecommerce

            # .env dosyalarını yedekle
            [ -f backend-laravel/.env ] && cp backend-laravel/.env /tmp/backend-laravel.env.bak
            [ -f admin-panel/.env.local ] && cp admin-panel/.env.local /tmp/admin-panel.env.bak

            echo "=== Pulling latest changes ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Restore .env files ==="
            # .env dosyalarını geri yükle
            [ -f /tmp/backend-laravel.env.bak ] && cp /tmp/backend-laravel.env.bak backend-laravel/.env
            [ -f /tmp/admin-panel.env.bak ] && cp /tmp/admin-panel.env.bak admin-panel/.env.local

            echo "=== Fix ALL File Permissions (After Git) ==="
            cd /var/www/quikecommerce/backend-laravel

            # Storage - Tüm dosya ve klasörleri recursive düzelt
            find storage -type f -exec chown www-data:www-data {} \;
            find storage -type d -exec chown www-data:www-data {} \;
            find storage -type f -exec chmod 664 {} \;
            find storage -type d -exec chmod 775 {} \;

            # Bootstrap cache
            find bootstrap/cache -type f -exec chown www-data:www-data {} \;
            find bootstrap/cache -type d -exec chown www-data:www-data {} \;
            find bootstrap/cache -type f -exec chmod 664 {} \;
            find bootstrap/cache -type d -exec chmod 775 {} \;

            echo "=== Backend Laravel Setup ==="
            cd /var/www/quikecommerce/backend-laravel

            # .env yoksa oluştur
            if [ ! -f .env ]; then
              cp .env.example .env
              php artisan key:generate
              echo "WARNING: New .env created - configure database settings!"
            fi

            composer install --no-dev --optimize-autoloader --no-interaction

            # Cache işlemlerinden ÖNCE izinleri kontrol et
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear

            # Cache oluştur
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Migration
            php artisan migrate --force || echo "Migration skipped"

            echo "=== Run Essential Seeders ==="
            php artisan db:seed --class=RolesSeeder --force || true
            php artisan db:seed --class=UserSeeder --force || true
            php artisan db:seed --class=PermissionAdminSeeder --force || true

            echo "=== Fix Storage Permissions (After Laravel Operations) ==="
            find storage -type f -exec chown www-data:www-data {} \;
            find storage -type d -exec chown www-data:www-data {} \;
            find bootstrap/cache -type f -exec chown www-data:www-data {} \;
            find bootstrap/cache -type d -exec chown www-data:www-data {} \;

            echo "=== Customer Web (Flutter) Setup ==="
            cd /var/www/quikecommerce/customer-app-and-web-flutter

            # Flutter SDK path
            export PATH="/root/dev/flutter/bin:$PATH"

            # Flutter versiyonunu kontrol et
            echo "Flutter version: $(flutter --version --suppress-analytics | head -1 || echo 'Flutter not found')"

            # Clean old build
            flutter clean || echo "Flutter clean skipped"

            # Dependencies install
            flutter pub get

            # Build web (production mode)
            flutter build web --release --no-tree-shake-icons

            # Build klasörü izinlerini düzelt (nginx www-data ile okuyabilmeli)
            echo "=== Fix Flutter Build Permissions ==="
            [ -d build/web ] && find build/web -type f -exec chmod 644 {} \;
            [ -d build/web ] && find build/web -type d -exec chmod 755 {} \;

            # Verify build
            echo "Flutter build verification:"
            ls -la /var/www/quikecommerce/customer-app-and-web-flutter/build/web/index.html 2>/dev/null && echo "index.html OK" || echo "ERROR: index.html missing!"

            echo "=== Admin Panel Setup ==="
            cd /var/www/quikecommerce/admin-panel

            # Node versiyonunu kontrol et (Next.js >= 20 gerektirir)
            export NVM_DIR="/root/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            echo "Node version: $(node --version)"

            # devDependencies dahil kur (fs-extra postbuild için gerekli)
            # npm install kullan (npm ci her seferinde node_modules siler, VPS'te çok yavaş)
            NODE_ENV=development npm install --legacy-peer-deps --prefer-offline

            # PM2'yi durdur (deploy/ klasörü yeniden oluşturulacak)
            pm2 stop quickecommerce-admin || true

            # Build + postbuild (deploy/ klasörünü oluşturur)
            npm run build

            # .env.local dosyasını deploy klasörüne de kopyala
            [ -f .env.local ] && cp .env.local deploy/.env.local

            echo "=== PM2 Restart ==="
            pm2 restart quickecommerce-admin || pm2 start ecosystem.config.cjs --only quickecommerce-admin
            pm2 save

            echo "=== Verify Deploy ==="
            echo "Admin Panel deploy dir:"
            ls -la /var/www/quikecommerce/admin-panel/deploy/server.js 2>/dev/null && echo "server.js OK" || echo "ERROR: server.js missing!"
            sleep 3
            pm2 status

            echo "=== Final Permission Check ==="
            cd /var/www/quikecommerce/backend-laravel
            ls -la storage/framework/cache/data/ | head -10

            echo "=== Deploy Complete ==="
            echo "✅ Backend Laravel: Ready"
            echo "✅ Customer Web (Flutter): Ready at https://sportoonline.com"
            echo "✅ Admin Panel (Next.js): Ready at https://panel.sportoonline.com"
